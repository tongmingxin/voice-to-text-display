<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#1a1a2e">
  <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="expires" content="0">
  <meta name="description" content="è¯­éŸ³è½¬å¤§å­—æ˜¾ç¤º - å¬éšœæ²Ÿé€šè¾…åŠ©å·¥å…·">
  <title>è¯­éŸ³è½¬å¤§å­—</title>
  <link rel="manifest" href="manifest.json">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ¤</text></svg>">
  <style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
html, body {
  height: 100%; overflow: hidden;
  font-family: -apple-system, BlinkMacSystemFont, "PingFang SC", "Hiragino Sans GB",
    "Microsoft YaHei", "Helvetica Neue", Arial, sans-serif;
  -webkit-tap-highlight-color: transparent;
  -webkit-touch-callout: none;
  -webkit-user-select: none; user-select: none;
}
body { background: #1a1a2e; color: #ffffff; }
.hidden { display: none !important; }
.app { display: flex; flex-direction: column; height: 100%; width: 100%; position: fixed; top: 0; left: 0; }
.toolbar {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 14px; background: rgba(26,26,46,0.95); flex-shrink: 0;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}
.toolbar-left, .toolbar-right { display: flex; align-items: center; gap: 6px; }
.app-name { font-size: 0.95rem; font-weight: 600; color: rgba(255,255,255,0.7); }
.app-ver { font-size: 0.6rem; color: rgba(255,255,255,0.25); margin-left: 6px; }
.icon-btn {
  border: none; background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.75);
  padding: 5px 10px; border-radius: 14px; font-size: 0.78rem; cursor: pointer;
  font-family: inherit; font-weight: 600; transition: background 0.2s;
}
.icon-btn:active { background: rgba(255,255,255,0.2); }
.text-display { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 1.2rem 1rem; -webkit-overflow-scrolling: touch; }
.text-content { width: 100%; min-height: 100%; }
.text-content .text-line {
  font-weight: 700; line-height: 1.5; color: #ffffff;
  margin-bottom: 0.4em; word-break: break-all; animation: fadeIn 0.3s ease-out;
}
.text-content .text-line.latest-session { color: #ffd700; }
.text-content .session-line .text-line { animation: none; margin-bottom: 0.25em; }
.text-content .session-line .session-final,
.text-content .session-line .session-interim {
  color: #ffd700 !important; font-style: italic !important; opacity: 1;
}
.placeholder-text { font-size: 1.1rem; color: rgba(255,255,255,0.2); text-align: center; line-height: 2; padding-top: 30vh; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
.bottom-bar {
  display: flex; justify-content: center; align-items: center;
  padding: 14px 16px; padding-bottom: calc(14px + env(safe-area-inset-bottom, 0px));
  background: rgba(26,26,46,0.95); flex-shrink: 0;
  border-top: 1px solid rgba(255,255,255,0.06);
}
.talk-btn {
  display: flex; align-items: center; justify-content: center; gap: 8px;
  width: 100%; max-width: 280px; padding: 14px 0; border: none; border-radius: 28px;
  background: linear-gradient(145deg, #e94560, #c23152); color: white; cursor: pointer;
  font-family: inherit; box-shadow: 0 4px 20px rgba(233,69,96,0.35);
  transition: transform 0.15s, box-shadow 0.15s;
}
.talk-btn:active, .talk-btn.recording { transform: scale(0.97); }
.talk-btn.recording { animation: pulse-btn 1.2s ease-in-out infinite; }
.talk-btn .mic-icon { width: 22px; height: 22px; }
.talk-btn .btn-text { font-size: 1rem; font-weight: 600; }
@keyframes pulse-btn {
  0%, 100% { box-shadow: 0 4px 20px rgba(233,69,96,0.35), 0 0 0 0 rgba(233,69,96,0.25); }
  50% { box-shadow: 0 4px 20px rgba(233,69,96,0.5), 0 0 0 10px rgba(233,69,96,0); }
}
.modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 9999; }
.modal-content { background: #16213e; border-radius: 16px; padding: 2rem; max-width: 340px; width: 85%; text-align: center; }
.modal-content h2 { font-size: 1.2rem; margin-bottom: 0.8rem; color: #e94560; }
.modal-content p { font-size: 0.9rem; color: rgba(255,255,255,0.8); margin-bottom: 0.4rem; line-height: 1.5; }
.modal-content ul { text-align: left; padding-left: 1.5rem; margin: 0.6rem 0 1.2rem; color: rgba(255,255,255,0.7); font-size: 0.85rem; line-height: 1.8; }
.modal-close-btn { border: none; background: #e94560; color: white; padding: 8px 24px; border-radius: 20px; font-size: 0.95rem; cursor: pointer; font-family: inherit; }
@supports (padding-top: env(safe-area-inset-top)) { .toolbar { padding-top: calc(10px + env(safe-area-inset-top)); } }
.text-display::-webkit-scrollbar { width: 3px; }
.text-display::-webkit-scrollbar-track { background: transparent; }
.text-display::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }
  </style>
</head>
<body>
  <div id="app" class="app">
    <div class="toolbar">
      <div class="toolbar-left">
        <span class="app-name">è¯­éŸ³è½¬å¤§å­—</span>
        <span class="app-ver" id="verLabel">v20</span>
      </div>
      <div class="toolbar-right">
        <button id="fontDown" class="icon-btn" title="ç¼©å°å­—ä½“">A-</button>
        <button id="fontUp" class="icon-btn" title="æ”¾å¤§å­—ä½“">A+</button>
        <button id="clearBtn" class="icon-btn" title="æ¸…ç©º">æ¸…ç©º</button>
      </div>
    </div>
    <div id="textDisplay" class="text-display">
      <div id="textContent" class="text-content">
        <p class="placeholder-text">é•¿æŒ‰ä¸‹æ–¹æŒ‰é’®è¯´è¯<br>æ–‡å­—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>
      </div>
    </div>
    <div class="bottom-bar">
      <button id="talkBtn" class="talk-btn">
        <svg class="mic-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
          <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
        </svg>
        <span class="btn-text">é•¿æŒ‰è¯´è¯</span>
      </button>
    </div>
  </div>
  <div id="unsupportedModal" class="modal hidden">
    <div class="modal-content">
      <h2>æµè§ˆå™¨ä¸æ”¯æŒ</h2>
      <p>æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«åŠŸèƒ½ã€‚</p>
      <p>è¯·ä½¿ç”¨ä»¥ä¸‹æµè§ˆå™¨ï¼š</p>
      <ul>
        <li>Android æ‰‹æœºï¼šChrome æµè§ˆå™¨</li>
        <li>iPhone / iPadï¼šSafari æµè§ˆå™¨</li>
        <li>ç”µè„‘ï¼šChrome æµè§ˆå™¨</li>
      </ul>
      <button class="modal-close-btn" onclick="this.closest('.modal').classList.add('hidden')">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>

<!-- ========== è®¯é£è¯­éŸ³å¬å†™ WebAPI å¼•æ“ ========== -->
<script>
var XfyunASR = (function () {
  'use strict';

  var CFG = {
    appId: '419554e8',
    apiKey: 'ddfc9b1bcb85d8d2c6ca8b7d0f9d60c9',
    apiSecret: 'OTE3ODZjNmMwMWJhZTJmZDMwNWY5Mzg0',
    url: 'wss://iat-api.xfyun.cn/v2/iat'
  };

  var ws = null, mediaStream = null, audioCtx = null, processor = null;
  var sendTimer = null, audioBuf = [], resultMap = {};
  var isFirstFrame = true, active = false, stopping = false;
  var cb = { onResult: null, onError: null, onEnd: null };
  var gen = 0;

  function uint8ToBase64(arr) {
    var bin = '';
    for (var i = 0; i < arr.length; i++) bin += String.fromCharCode(arr[i]);
    return btoa(bin);
  }

  function resample(input, fromRate, toRate) {
    if (fromRate === toRate) return input;
    var ratio = fromRate / toRate;
    var len = Math.round(input.length / ratio);
    var out = new Float32Array(len);
    for (var i = 0; i < len; i++) {
      var pos = i * ratio;
      var idx = Math.floor(pos);
      var frac = pos - idx;
      out[i] = input[idx] * (1 - frac) + input[Math.min(idx + 1, input.length - 1)] * frac;
    }
    return out;
  }

  function floatToInt16(f32) {
    var i16 = new Int16Array(f32.length);
    for (var i = 0; i < f32.length; i++) {
      var s = Math.max(-1, Math.min(1, f32[i]));
      i16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
    }
    return i16;
  }

  function mergeBuffers() {
    if (audioBuf.length === 0) return null;
    var total = 0;
    for (var i = 0; i < audioBuf.length; i++) total += audioBuf[i].length;
    var merged = new Int16Array(total);
    var off = 0;
    for (var j = 0; j < audioBuf.length; j++) { merged.set(audioBuf[j], off); off += audioBuf[j].length; }
    audioBuf = [];
    return merged;
  }

  function getAuthUrl() {
    var host = 'iat-api.xfyun.cn';
    var date = new Date().toUTCString();
    var signOrigin = 'host: ' + host + '\ndate: ' + date + '\nGET /v2/iat HTTP/1.1';
    var enc = new TextEncoder();
    return crypto.subtle.importKey(
      'raw', enc.encode(CFG.apiSecret),
      { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
    ).then(function (key) {
      return crypto.subtle.sign('HMAC', key, enc.encode(signOrigin));
    }).then(function (sigBuf) {
      var signature = uint8ToBase64(new Uint8Array(sigBuf));
      var authOrigin = 'api_key="' + CFG.apiKey +
        '", algorithm="hmac-sha256", headers="host date request-line", signature="' + signature + '"';
      return CFG.url +
        '?authorization=' + encodeURIComponent(btoa(authOrigin)) +
        '&date=' + encodeURIComponent(date) +
        '&host=' + encodeURIComponent(host);
    });
  }

  function startCapture() {
    return navigator.mediaDevices.getUserMedia({
      audio: { channelCount: 1, echoCancellation: true, noiseSuppression: true }
    }).then(function (stream) {
      mediaStream = stream;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      var source = audioCtx.createMediaStreamSource(stream);
      processor = audioCtx.createScriptProcessor(4096, 1, 1);
      processor.onaudioprocess = function (e) {
        if (!active) return;
        var raw = e.inputBuffer.getChannelData(0);
        audioBuf.push(floatToInt16(resample(raw, audioCtx.sampleRate, 16000)));
      };
      source.connect(processor);
      processor.connect(audioCtx.destination);
    });
  }

  function stopCapture() {
    if (processor) { try { processor.disconnect(); } catch (e) {} processor = null; }
    if (audioCtx) { try { audioCtx.close(); } catch (e) {} audioCtx = null; }
    if (mediaStream) { mediaStream.getTracks().forEach(function (t) { t.stop(); }); mediaStream = null; }
  }

  function sendFrame() {
    if (!ws || ws.readyState !== WebSocket.OPEN) return;
    var pcm = mergeBuffers();
    var b64 = (pcm && pcm.length > 0) ? uint8ToBase64(new Uint8Array(pcm.buffer)) : '';
    if (isFirstFrame) {
      isFirstFrame = false;
      ws.send(JSON.stringify({
        common: { app_id: CFG.appId },
        business: { language: 'zh_cn', domain: 'iat', accent: 'mandarin', ptt: 0 },
        data: { status: 0, format: 'audio/L16;rate=16000', encoding: 'raw', audio: b64 }
      }));
      return;
    }
    if (stopping) {
      if (sendTimer) { clearInterval(sendTimer); sendTimer = null; }
      ws.send(JSON.stringify({ data: { status: 2, format: 'audio/L16;rate=16000', encoding: 'raw', audio: b64 } }));
      return;
    }
    if (!b64) return;
    ws.send(JSON.stringify({ data: { status: 1, format: 'audio/L16;rate=16000', encoding: 'raw', audio: b64 } }));
  }

  function parseWords(result) {
    if (!result || !result.ws) return '';
    var text = '';
    for (var i = 0; i < result.ws.length; i++) { var cw = result.ws[i].cw; if (cw && cw[0]) text += cw[0].w; }
    return text;
  }

  function getFullText() {
    var keys = Object.keys(resultMap).map(Number).sort(function (a, b) { return a - b; });
    var text = '';
    for (var i = 0; i < keys.length; i++) text += resultMap[keys[i]];
    return text;
  }

  function abort() {
    active = false; stopping = false;
    stopCapture();
    if (sendTimer) { clearInterval(sendTimer); sendTimer = null; }
    if (ws) {
      ws.onmessage = null; ws.onerror = null; ws.onclose = null;
      try { ws.close(); } catch (e) {}
      ws = null;
    }
    cb.onResult = null; cb.onError = null; cb.onEnd = null;
  }

  function cleanup() {
    var wasActive = active;
    active = false; stopping = false;
    stopCapture();
    if (sendTimer) { clearInterval(sendTimer); sendTimer = null; }
    if (ws) { try { ws.close(); } catch (e) {} ws = null; }
    if (wasActive && cb.onEnd) cb.onEnd();
  }

  function start(onResult, onError, onEnd) {
    if (active) abort();

    var myGen = ++gen;
    active = true; stopping = false; isFirstFrame = true;
    resultMap = {}; audioBuf = [];
    cb.onResult = onResult; cb.onError = onError; cb.onEnd = onEnd;

    return startCapture().then(function () {
      if (myGen !== gen) return;
      return getAuthUrl();
    }).then(function (url) {
      if (myGen !== gen || !url) return;
      return new Promise(function (resolve, reject) {
        ws = new WebSocket(url);
        ws.onopen = function () {
          if (myGen !== gen) { try { ws.close(); } catch (e) {} return; }
          sendTimer = setInterval(sendFrame, 40);
          resolve();
        };
        ws.onmessage = function (e) {
          if (myGen !== gen) return;
          var resp;
          try { resp = JSON.parse(e.data); } catch (err) { return; }
          if (resp.code !== 0) {
            if (cb.onError) cb.onError('è®¯é£é”™è¯¯(' + resp.code + '): ' + (resp.message || ''));
            cleanup();
            return;
          }
          if (resp.data && resp.data.result) {
            var sn = resp.data.result.sn;
            var text = parseWords(resp.data.result);
            if (text) resultMap[sn] = text;
            if (cb.onResult) cb.onResult(getFullText(), resp.data.status === 2);
          }
          if (resp.data && resp.data.status === 2) cleanup();
        };
        ws.onerror = function () {
          if (myGen !== gen) return;
          reject(new Error('è®¯é£è¿æ¥å¤±è´¥'));
        };
        ws.onclose = function () {
          if (myGen !== gen) return;
          if (active) cleanup();
        };
      });
    }).catch(function (err) {
      if (myGen !== gen) return;
      if (cb.onError) cb.onError('è®¯é£å¯åŠ¨å¤±è´¥: ' + (err.message || err));
      cleanup();
    });
  }

  function stop() {
    if (!active) return;
    stopping = true; stopCapture(); sendFrame();
  }

  function isSupported() {
    return !!(
      navigator.mediaDevices && navigator.mediaDevices.getUserMedia &&
      (window.AudioContext || window.webkitAudioContext) &&
      window.WebSocket && window.crypto && window.crypto.subtle
    );
  }

  return { start: start, stop: stop, isSupported: isSupported };
})();
</script>

<!-- ========== æ ¸å¿ƒé€»è¾‘ ========== -->
<script>
(function () {
  'use strict';

  var VER = 'v20';
  var talkBtn = document.getElementById('talkBtn');
  var textContent = document.getElementById('textContent');
  var textDisplay = document.getElementById('textDisplay');
  var clearBtn = document.getElementById('clearBtn');
  var fontUp = document.getElementById('fontUp');
  var fontDown = document.getElementById('fontDown');
  var unsupportedModal = document.getElementById('unsupportedModal');
  var verLabel = document.getElementById('verLabel');

  var isRecording = false;
  var pendingFinalize = false;
  var recognition = null;
  var hasText = false;
  var useXfyun = false;

  var wsEverWorked = false;
  var wsAttempts = 0;
  var WS_MAX_ATTEMPTS = 2;
  var wsErrorHandled = false;

  var sessionSegments = [];
  var xfText = '';
  var xfHadError = false;
  var xfStopTimer = null;

  var FONT_SIZES = [5, 6, 7, 8, 10, 12, 14];
  var fontIndex = 3;

  var SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  var hasXfyun = (typeof XfyunASR !== 'undefined') && XfyunASR.isSupported();

  function updateVerLabel() {
    var engine = useXfyun ? 'è®¯é£' : (SR ? 'é»˜è®¤' : 'æ— ');
    verLabel.textContent = VER + ' [' + engine + ']';
  }
  updateVerLabel();

  if (!SR && !hasXfyun) { unsupportedModal.classList.remove('hidden'); return; }
  if (!SR && hasXfyun) { useXfyun = true; updateVerLabel(); }

  function applyFontSize() { textContent.style.fontSize = FONT_SIZES[fontIndex] + 'vw'; }
  applyFontSize();

  fontUp.addEventListener('click', function () {
    if (fontIndex < FONT_SIZES.length - 1) { fontIndex++; applyFontSize(); showToast('å­—ä½“å·²æ”¾å¤§'); }
  });
  fontDown.addEventListener('click', function () {
    if (fontIndex > 0) { fontIndex--; applyFontSize(); showToast('å­—ä½“å·²ç¼©å°'); }
  });

  // =======================================================
  //  æ˜¾ç¤ºé€»è¾‘
  // =======================================================

  function clearPlaceholder() {
    var ph = textContent.querySelector('.placeholder-text');
    if (ph) ph.remove();
  }

  function scrollToBottom() {
    requestAnimationFrame(function () { textDisplay.scrollTop = textDisplay.scrollHeight; });
  }

  // å½•éŸ³ä¸­ï¼šå¤šè¡Œæ˜¾ç¤ºï¼ˆWeb Speech API ä½¿ç”¨ï¼Œæ¯ä¸ª segment ä¸€è¡Œï¼‰
  function showSessionSegments(segments) {
    clearPlaceholder();
    var el = textContent.querySelector('.session-line');
    if (!el) {
      el = document.createElement('div');
      el.className = 'session-line';
      textContent.appendChild(el);
    }
    var lines = [];
    for (var i = 0; i < segments.length; i++) {
      var seg = segments[i];
      if (seg && seg.text && seg.text.trim()) lines.push(seg);
    }
    while (el.children.length > lines.length) el.removeChild(el.lastChild);
    for (var j = 0; j < lines.length; j++) {
      var p = j < el.children.length ? el.children[j] : el.appendChild(document.createElement('p'));
      var cls = 'text-line ' + (lines[j].isFinal ? 'session-final' : 'session-interim');
      if (p.className !== cls) p.className = cls;
      var txt = lines[j].text.trim();
      if (p.textContent !== txt) p.textContent = txt;
    }
    scrollToBottom();
  }

  // å½•éŸ³ä¸­ï¼šå•è¡Œæ˜¾ç¤ºï¼ˆè®¯é£ä½¿ç”¨ï¼‰
  function showSessionText(text) {
    clearPlaceholder();
    var el = textContent.querySelector('.session-line');
    if (!el) {
      el = document.createElement('div');
      el.className = 'session-line';
      textContent.appendChild(el);
    }
    if (el.children.length === 0) {
      var p = document.createElement('p');
      p.className = 'text-line session-interim';
      el.appendChild(p);
    }
    el.children[0].textContent = text;
    while (el.children.length > 1) el.removeChild(el.lastChild);
    scrollToBottom();
  }

  // æ¾æ‰‹ï¼šå¤šè¡Œè½ç›˜ï¼ˆWeb Speech API ä½¿ç”¨ï¼‰
  function commitSegments(segments) {
    var el = textContent.querySelector('.session-line');
    if (el) el.remove();
    var old = textContent.querySelectorAll('.latest-session');
    for (var i = 0; i < old.length; i++) old[i].classList.remove('latest-session');
    var added = false;
    for (var j = 0; j < segments.length; j++) {
      var seg = segments[j];
      if (!seg || !seg.text || !seg.text.trim()) continue;
      clearPlaceholder();
      added = true;
      var p = document.createElement('p');
      p.className = 'text-line latest-session';
      p.textContent = seg.text.trim();
      textContent.appendChild(p);
    }
    if (added) { hasText = true; scrollToBottom(); }
  }

  // æ¾æ‰‹ï¼šå•è¡Œè½ç›˜ï¼ˆè®¯é£ä½¿ç”¨ï¼‰
  function commitSession(text) {
    var el = textContent.querySelector('.session-line');
    if (el) el.remove();
    var old = textContent.querySelectorAll('.latest-session');
    for (var i = 0; i < old.length; i++) old[i].classList.remove('latest-session');
    var trimmed = text.trim();
    if (trimmed) {
      clearPlaceholder();
      hasText = true;
      var p = document.createElement('p');
      p.className = 'text-line latest-session';
      p.textContent = trimmed;
      textContent.appendChild(p);
      scrollToBottom();
    }
  }

  function resetUI() {
    isRecording = false;
    pendingFinalize = false;
    talkBtn.classList.remove('recording');
    talkBtn.querySelector('.btn-text').textContent = 'é•¿æŒ‰è¯´è¯';
  }

  function switchToXfyun() {
    useXfyun = true;
    updateVerLabel();
    if (recognition) { try { recognition.abort(); } catch (e) {} recognition = null; }
    pendingFinalize = false;
    var el = textContent.querySelector('.session-line');
    if (el) el.remove();
    resetUI();
    showToast('å·²åˆ‡æ¢è¯†åˆ«å¼•æ“ï¼Œè¯·å†æ¬¡é•¿æŒ‰è¯´è¯');
  }

  // =======================================================
  //  Web Speech API å¼•æ“
  // =======================================================

  function createRecognition() {
    var rec = new SR();
    rec.lang = 'zh-CN';
    rec.interimResults = true;
    rec.continuous = true;
    rec.maxAlternatives = 1;
    rec.onresult = wsOnResult;
    rec.onerror = wsOnError;
    rec.onend = wsOnEnd;
    return rec;
  }

  function hasWSText() {
    for (var i = 0; i < sessionSegments.length; i++) {
      if (sessionSegments[i] && sessionSegments[i].text && sessionSegments[i].text.trim()) return true;
    }
    return false;
  }

  function shouldSwitch() {
    return !wsEverWorked && wsAttempts >= WS_MAX_ATTEMPTS && hasXfyun && !useXfyun;
  }

  function wsOnResult(event) {
    if (!isRecording && !pendingFinalize) return;
    wsEverWorked = true;
    for (var i = event.resultIndex; i < event.results.length; i++) {
      var r = event.results[i];
      sessionSegments[i] = { text: (r[0] && r[0].transcript) || '', isFinal: !!r.isFinal };
    }
    sessionSegments.length = event.results.length;
    showSessionSegments(sessionSegments);
  }

  function wsOnError(event) {
    wsErrorHandled = true;

    if (event.error === 'network' || event.error === 'service-not-allowed') {
      if (!useXfyun && hasXfyun) { switchToXfyun(); return; }
      showToast('æ— æ³•è¿æ¥è¯­éŸ³æœåŠ¡'); return;
    }
    if (event.error === 'not-allowed') {
      if (shouldSwitch()) { switchToXfyun(); return; }
      showToast('è¯·å…è®¸ä½¿ç”¨éº¦å…‹é£æƒé™'); return;
    }
    if (event.error === 'no-speech') {
      if (shouldSwitch()) { switchToXfyun(); return; }
      showToast('æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•'); return;
    }
    if (event.error === 'audio-capture') { showToast('æ— æ³•å½•éŸ³ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£'); return; }
    if (shouldSwitch()) { switchToXfyun(); return; }
    showToast('è¯†åˆ«å‡ºé”™(' + event.error + ')');
  }

  function wsOnEnd() {
    if (wsErrorHandled) {
      wsErrorHandled = false;
      if (useXfyun) return;
      if (pendingFinalize || isRecording) {
        commitSegments(sessionSegments);
        recognition = null;
        resetUI();
      }
      return;
    }

    if (pendingFinalize) {
      pendingFinalize = false;
      if (!hasWSText() && shouldSwitch()) { switchToXfyun(); return; }
      commitSegments(sessionSegments);
      recognition = null;
      if (!hasText) showToast('æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•');
    } else if (isRecording) {
      if (!hasWSText() && shouldSwitch()) { switchToXfyun(); return; }
      commitSegments(sessionSegments);
      recognition = null;
      resetUI();
      if (!hasText) showToast('è¯†åˆ«ä¸­æ–­ï¼Œè¯·é‡è¯•');
    }
  }

  function startWS() {
    wsAttempts++;
    sessionSegments = [];
    wsErrorHandled = false;
    recognition = createRecognition();
    try {
      recognition.start();
    } catch (e) {
      if (hasXfyun) { useXfyun = true; updateVerLabel(); startXF(); showToast('å·²åˆ‡æ¢è¯†åˆ«å¼•æ“'); }
      else { resetUI(); showToast('å¯åŠ¨å¤±è´¥ï¼Œè¯·é‡è¯•'); }
    }
  }

  function stopWS() {
    pendingFinalize = true;
    if (recognition) { try { recognition.stop(); } catch (e) {} }
    setTimeout(function () {
      if (pendingFinalize) {
        pendingFinalize = false;
        commitSegments(sessionSegments);
        if (recognition) { try { recognition.abort(); } catch (e) {} recognition = null; }
        if (!hasText) showToast('è¯†åˆ«è¶…æ—¶ï¼Œè¯·é‡è¯•');
      }
    }, 5000);
  }

  // =======================================================
  //  è®¯é£å¼•æ“
  // =======================================================

  function startXF() {
    if (xfStopTimer) { clearTimeout(xfStopTimer); xfStopTimer = null; }
    xfText = '';
    xfHadError = false;
    pendingFinalize = false;
    XfyunASR.start(
      function (text) { xfText = text; if (text) showSessionText(text); },
      function (msg) { xfHadError = true; showToast(msg || 'è¯†åˆ«å‡ºé”™'); },
      function () {
        if (xfStopTimer) { clearTimeout(xfStopTimer); xfStopTimer = null; }
        commitSession(xfText);
        resetUI();
        if (!hasText && !xfHadError) showToast('æœªæ£€æµ‹åˆ°è¯­éŸ³ï¼Œè¯·é‡è¯•');
      }
    );
  }

  function stopXF() {
    pendingFinalize = true;
    XfyunASR.stop();
    xfStopTimer = setTimeout(function () {
      xfStopTimer = null;
      if (pendingFinalize) {
        commitSession(xfText);
        resetUI();
        if (!hasText && !xfHadError) showToast('è¯†åˆ«è¶…æ—¶ï¼Œè¯·é‡è¯•');
      }
    }, 4000);
  }

  // =======================================================
  //  å½•éŸ³æ§åˆ¶
  // =======================================================

  function startRecording() {
    if (isRecording) return;
    isRecording = true;
    pendingFinalize = false;
    talkBtn.classList.add('recording');
    talkBtn.querySelector('.btn-text').textContent = 'æ¾å¼€ç»“æŸ';
    if (useXfyun) startXF(); else startWS();
  }

  function finishRecording() {
    if (!isRecording) return;
    isRecording = false;
    talkBtn.classList.remove('recording');
    talkBtn.querySelector('.btn-text').textContent = 'é•¿æŒ‰è¯´è¯';
    if (useXfyun) stopXF(); else stopWS();
  }

  // =======================================================
  //  æŒ‰é’®äº‹ä»¶
  // =======================================================

  var touchActive = false;
  talkBtn.addEventListener('touchstart', function (e) { e.preventDefault(); touchActive = true; startRecording(); }, { passive: false });
  talkBtn.addEventListener('touchend', function (e) { e.preventDefault(); if (touchActive) { touchActive = false; finishRecording(); } }, { passive: false });
  talkBtn.addEventListener('touchcancel', function (e) { e.preventDefault(); if (touchActive) { touchActive = false; finishRecording(); } }, { passive: false });
  talkBtn.addEventListener('mousedown', function (e) { if (touchActive) return; e.preventDefault(); startRecording(); });
  talkBtn.addEventListener('mouseup', function (e) { if (touchActive) return; e.preventDefault(); finishRecording(); });
  talkBtn.addEventListener('mouseleave', function () { if (touchActive) return; if (isRecording) finishRecording(); });
  talkBtn.addEventListener('contextmenu', function (e) { e.preventDefault(); });

  clearBtn.addEventListener('click', function () {
    textContent.innerHTML = '<p class="placeholder-text">é•¿æŒ‰ä¸‹æ–¹æŒ‰é’®è¯´è¯<br>æ–‡å­—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</p>';
    hasText = false;
  });

  function showToast(msg) {
    var t = document.getElementById('toast');
    if (!t) {
      t = document.createElement('div'); t.id = 'toast';
      t.style.cssText = 'position:fixed;bottom:18%;left:50%;transform:translateX(-50%);background:rgba(0,0,0,0.85);color:#fff;padding:10px 20px;border-radius:20px;font-size:0.9rem;z-index:9999;transition:opacity 0.3s;pointer-events:none;max-width:85vw;text-align:center;';
      document.body.appendChild(t);
    }
    t.textContent = msg; t.style.opacity = '1';
    clearTimeout(t._tm);
    t._tm = setTimeout(function () { t.style.opacity = '0'; }, 2500);
  }

  document.addEventListener('gesturestart', function (e) { e.preventDefault(); });
  document.addEventListener('gesturechange', function (e) { e.preventDefault(); });
})();
</script>
</body>
</html>
